---
# Publishes the OpenHands PyPi package
name: Publish PyPi Package

on:
    workflow_dispatch:
        inputs:
            reason:
                description: What are you publishing?
                required: true
                type: choice
                options:
                    - cli
                default: cli
    push:
        tags:
            - '*'

jobs:
    release-cli:
        name: Publish CLI to PyPI
        runs-on: blacksmith-2vcpu-ubuntu-2404
        permissions:
            id-token: write
    # Run when manually dispatched for "cli" OR for any tag pushes
        if: |
            (github.event_name == 'workflow_dispatch' && github.event.inputs.reason == 'cli')
            || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: 3.12

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  version: latest

            - name: Build CLI package
              run: |
                  # Clean dist directory to avoid conflicts with binary builds
                  rm -rf dist/
                  uv build

            - name: Publish CLI to PyPI
              run: |
                  uv publish
